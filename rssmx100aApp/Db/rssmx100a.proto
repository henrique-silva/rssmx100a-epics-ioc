###########

################################################################################
#
# INFN - LNL
#
# Protocol file to Rohde&Schwarz SMA100A
#
# Author: Mauro Giacchini
# Email : mauro.giacchini@lnl.infn.it
#
# Based on previous version from Benjamin (BESSY)
#
# Edited by Vitor Finotti Ferreira (LNLS)
#
################################################################################
#
# Communication setup
#
OutTerminator = CR LF;
InTerminator = LF;
ExtraInput = Ignore;
#
#
################################################################################
#
setupSweepMode {
    out "SOUR:SWE:FREQ:MODE STEP";
    out "SOUR:SWE:FREQ:SPAC LIN";
    out "TRIG:FSW:SOUR EXT";
}
################################################################################
#
inFrq {
    out "FREQ?";
    in "%f";
}
################################################################################
#
outFrq {
    out "FREQ %f";
    @init { inFrq; };
}
################################################################################
#
inStartFrq {
    out "FREQ:STAR?";
    in "%f";
}
################################################################################
#
outStartFrq {
    out "FREQ:STAR %f";
    @init { inStartFrq; };
}
################################################################################
#
inStopFrq {
    out "FREQ:STOP?";
    in "%f";
}
################################################################################
#
outStopFrq {
    out "FREQ:STOP %f";
    @init { inStopFrq; };
}
################################################################################
#
inStepFrq {
    out "SWE:FREQ:STEP:LIN?";
    in "%f";
}
################################################################################
#
outStepFrq {
    out "SWE:FREQ:STEP:LIN %f";
    @init { inStepFrq; };
}
################################################################################
#
inLvl {
    out "LEVEL?";
    in "%f"
}
################################################################################
#
outLvl {
    out "LEVEL %f";
    @init { inLvl; };
}
################################################################################
#
inFmFrq {
    out "FM?";
    in "%f"
}
################################################################################
#
outFmFrq {
    out "FM %f";
    @init { inFmFrq; };
}
################################################################################
# get identification
inIdn {
    out "*IDN?";
    in "%s";
}
################################################################################
# reset to default state
outRst {
    out "%{|*RST; *WAI}";
}
################################################################################
# phase continuous frequency setting
inPhasCont {
    out "FREQ:PHAS:CONT:STAT?";
    in "%i";
}
################################################################################
#
outPhasCont {
    out "FREQ:PHAS:CONT:STAT %{OFF|ON}";
    @init { inPhasCont; }
}
################################################################################
# for quickly testing new commands and queries
test {
    out "%s"; in "%39c"
}
################################################################################
#
inFrqMode {
    out "FREQ:MODE?";
    in  "%{CW|SWE|LIST}";
}
################################################################################
#
outFrqMode {
    setupSweepMode;
    out "FREQ:MODE %{CW|SWE|LIST}";
    @init {
        setupSweepMode;
        inFrqMode;
    }
}
################################################################################
# Read the RF status  pag 390

inRFStat {
    out "OUTP?";
    in "%i";
}
################################################################################
# Set the RF status  pag 390

outRFStat {
    out "OUTP %{OFF|ON}";
    @init { inRFStat; };
}
################################################################################
# Read the RF output level pag. 560

inRFLvl {
    out "SOUR:POW:LEV:IMM:AMPL?";
    in "%f";
}
################################################################################
# Set the RF output level pag. 560

outRFLvl {
    out "SOUR:POW:LEV:IMM:AMPL %f";
    @init { inRFLvl; };
}

################################################################################
# storing current setting like set0.txt

strSet0 {
    out "*SAV 0";
    out "MMEM:STOR:STAT 0, '/var/user/pwrtests/set0.txt'";
}
################################################################################
# Store current SMA100A configuration on file selected by $1:setupFileName.VAL

strSetup {
    out "*SAV 0";
    out "MMEM:STOR:STAT 0, '/var/user/pwrtests/%(\$1:setupFileName.VAL)s.txt'";
}
################################################################################
# Load current SMA100A configuration on file selected by $1:setupFileName.VAL

lodSetup {
    out "MMEM:LOAD:STAT 0, '/var/user/pwrtests/%(\$1:setupFileName.VAL)s.txt'";
    out "*RCL 0";
}


################################################################################
# loading current setting like set0.txt

lodSet0 {
    out "MMEM:LOAD:STAT 0, '/var/user/pwrtests/set0.txt'";
    out "*RCL 0";
}

################################################################################
# storing current setting like set1.txt

strSet1 {
    out "*SAV 1";
    out "MMEM:STOR:STAT 1, '/var/user/pwrtests/set1.txt'";
}
################################################################################
# loading current setting like set0.txt

lodSet1 {
    out "MMEM:LOAD:STAT 1, '/var/user/pwrtests/set1.txt'";
    out "*RCL 1";
}
################################################################################
# Read the amplitude modulation status pag.457

inAMState {
    out "SOUR:AM:STAT?";
        in "%i"
}
################################################################################
# Set the amplitude modulation status pag.457

outAMState {
    out "SOUR:AM:STAT %{OFF|ON}";
    @init { inAMState; };
}
################################################################################
# Read the amplitude modulation source pag.456

inAMSour {
    out "SOUR:AM:SOUR?";
    in  "%{INT|EXT}";
}
################################################################################
# Set the amplitude modulation source pag.456

outAMSour {
    out "SOUR:AM:SOUR %{INT|EXT}";
    @init { inAMSour; };
}
################################################################################
# Read the amplitude modulation source pag.455

inAMSourInt {
    out "SOUR:AM:INT:SOUR?";
    in  "%{LF1|LF2|LF12|NOIS|LF1N|LF2N}";
}
################################################################################
# Set the amplitude modulation source pag.455

outAMSourInt {
     out "SOUR:AM:INT:SOUR %{LF1|LF2|LF12|NOIS|LF1N|LF2N}";
     @init { inAMSourInt; };
}
################################################################################
# Read the pulse generation status pag.560

inPGState {
    out "SOUR:PGEN:STAT?";
        in "%i"
}
################################################################################
# Set the pulse generation status pag.560

outPGState {
    out "SOUR:PGEN:STAT %{OFF|ON}";
    @init { inPGState; };
}
################################################################################
# Read the frequency modulation status pag.496

inFMState {
    out "SOUR:FM:STAT?";
        in "%i"
}
################################################################################
# Set the frequency modulation status pag.496

outFMState {
    out "SOUR:FM:STAT %{OFF|ON}";
    @init { inFMState; };
}
################################################################################
# Read the frequency of the LF output generator pag.526

inLFFrq {
    out "SOUR:LFO%(\$1:inc.VAL)s:FREQ?";
        in "%i"
}
################################################################################
# Read the frequency of the LF output generator pag.526

outLFFrq {
    out "SOUR:LFO%(\$1:inc.VAL)s:FREQ %i";
#    @init { wait 500; inLFFrq; };
}
################################################################################
# Read the shape of the LF output generator pag.535

inLFShap {
    out "SOUR:LFO%(\$1:inc.VAL)s:SHAP?";
    in  "%{SINE|SQU|TRI|TRAP}";
}
################################################################################
# Set the shape of the LF output generator pag.535

outLFShap {
    out "SOUR:LFO%(\$1:inc.VAL)s:SHAP %{SINE|SQU|TRI|TRAP}";
#    @init { inLFShap; };
}
################################################################################
# Read the frequency modulation source pag.499

inFMSour {
    out "SOUR:FM:SOUR?";
    in  "%{INT|INT,EXT|EXT|EDIG}";
}
################################################################################
# Set the frequency modulation source pag.499

outFMSour {
     out "SOUR:FM:SOUR %{INT|EXT|INT,EXT|EDIG}";
     @init { inFMSour; };
}
################################################################################
# Read the frequency modulation sensitivity pag.499

inFMSens {
    out "SOUR:FM:SENS?";
        in "%f"
}
################################################################################
# Read the frequency modulation mode pag.498

inFMMode {
    out "SOUR:FM:MODE?";
    in  "%{NORM|LNO}";
}
################################################################################
# Set the frequency modulation mode pag.498

outFMMode {
    out "SOUR:FM:MODE %{NORM|LNO}";
    @init { inFMMode; };
}
################################################################################
# Read the frequency modulation deviation pag.496

inFMDev {
    out "SOUR:FM:DEV?";
    in  "%i"
}
################################################################################
# Set the frequency modulation deviation pag.496

outFMDev {
    out "SOUR:FM:DEV %i";
    @init { inFMDev; };
}
################################################################################
# Read the pulse modulation status pag.581

inPMState {
    out "SOUR:PULM:STAT?";
        in "%i"
}
################################################################################
# Set the pulse modulation status pag.581

outPMState {
    out "SOUR:PULM:STAT %{OFF|ON}";
    @init { inPMState; };
}
################################################################################
# Read the pulse modulation width pag.591

inPMWidt {
    out "SOUR:PULM:WIDTH?";
        in "%f"
}
################################################################################
# Set the pulse modulation width pag.591

outPMWidt {
    out "SOUR:PULM:WIDTH %f";
    @init { inPMWidt; };
}
################################################################################
# Read the pulse modulation polarity pag.580

inPMPol {
    out "SOUR:PULM:POL?";
    in  "%{NORM|INV}";
}
################################################################################
# Set the pulse modulation polarity pag.580

outPMPol {
    out "SOUR:PULM:POL %{NORM|INV}";
    @init { inPMPol; };
}
################################################################################
# Read the pulse modulation period pag.579

inPMPer {
    out "SOUR:PULM:PER?";
        in "%f"
}
################################################################################
# Set the pulse modulation period pag.579

outPMPer {
    out "SOUR:PULM:PER %f";
    @init { inPMPer; };
}
################################################################################
# Read the pulse modulation mode pag.579

inPMMod {
    out "SOUR:PULM:MODE?";
    in  "%{SING|DOUB|PTR}";
}
################################################################################
# Set the pulse modulation mode pag.579

outPMMod {
    out "SOUR:PULM:MODE %{SING|DOUB|PTR}";
    @init { inPMMod; };
}
################################################################################
# Read the modulation subsystems status pag.557

inMOStat {
    out "SOUR:MOD:ALL:STAT?";
    in  "%i";
}
################################################################################
# Set the modulation subsystems status pag.557

outMOStat {
    out "SOUR:MOD:ALL:STAT %{OFF|ON}";
    @init { inMOStat; };
}
################################################################################
# Set the instrument on LOCAL operation mode pag.323

Local {
	out "%{|&GTL}";
}
################################################################################
# Read the synchronization bandwidth for an external reference signal

inExtBwid {
	out "SOUR:ROSC:EXT:SBAN?";
	in "%{WIDE|NARR}";
}
################################################################################
# Set the synchronization bandwidth for an external reference signal

outExtBwid {
	out "SOUR:ROSC:EXT:SBAN %{WIDE|NARR}";
	@init { inExtBwid; };
}	
################################################################################
# Read the reference frequency source

inRoscSrc {
	out "SOUR:ROSC:SOUR?";
	in "%{INT|EXT}";
}
################################################################################
# Set the reference frequency source

outRoscSrc {
	out "SOUR:ROSC:SOUR %{INT|EXT}";
	@init { inRoscSrc; };
}
################################################################################
# Read the frequency of the clock synthesis output signal

inCsynFreq {
	out "CSYN:FREQ?";
	in "%f";
}
################################################################################
# Set the frequency of the clock synthesis output signal

outCsynFreq {
	out "CSYN:FREQ %f";
	@init { inCsynFreq; };
}
################################################################################
# Read if generation of a system clock for differential outputs is activated/deactivated

inCsynState {
	out "CSYN:STAT?";
	in "%i";
}
################################################################################
# Activate/deactivate generation of a system clock for differential outputs

outCsynState {
	out "CSYN:STAT %{OFF|ON}";
	@init { inCsynState; };
}
#################################################################################
# Read the trigger source for the RF level sweep

inTrigSrc {
	out "TRIG:PSW:SOUR?";
	in "%{AUTO|SING|EXT|EAUT}";
}
#################################################################################
# Set the trigger source for the RF level sweep

outTrigSrc {
	out "TRIG:PSW:SOUR %{AUTO|SING|EXT|EAUT}";
	@init { inTrigSrc; };
}
##################################################################################
# Read the modulation depth of the AM signal in percent

inAMDepth {
	out "SOUR:AM:DEPT?";
	in "%f";
}
#################################################################################
# Set the modulation depth of the AM signal in percent

outAMDepth {
	out "SOUR:AM:DEPT %f";
	@init { inAMDepth; };
}
#################################################################################
# Read the coupling mode for the external AM signal

inAMExtCoup {
	out "SOUR:AM:EXT:COUP?";
	in "%{AC|DC}";
}
#################################################################################
# Set the coupling mode for the external AM signal

outAMExtCoup {
	out "SOUR:AM:EXT:COUP %{AC|DC}";
	@init { inAMExtCoup; };
}
##################################################################################
# Read the depth of the internal AM signal in Hz

inAMIntDepth {
	out "SOUR:AM:INT:DEPT?";
	in "%f";
}
##################################################################################
# Set the depth of the internal AM signal in Hz

outAMIntDepth {
	out "SOUR:AM:INT:DEPT %f";
	@init { inAMIntDepth; };
}
##################################################################################
# Read AM sensitivity in percent

inAMSens {
	out "SOUR:AM:SENS?";
	in "%f";
}
##################################################################################
# Read PM delay

inPMDelay {
	out "SOUR:PULM:DEL?";
	in "%f";
}
##################################################################################
# Set PM Delay

outPMDelay {
	out "SOUR:PULM:DEL %f";
	@init { inPMDelay; };
}
###################################################################################
# Read the source for the PM signal

inPMSrc {
	out "SOUR:PULM:SOUR?";
	in "%{INT|EXT}";
}
##################################################################################
# Set the source for the PM signal

outPMSrc {
	out "SOUR:PULM:SOUR %{INT|EXT}";
	@init { inPMSrc; };
}
##################################################################################
# Read trigger mode for PM signal

inPMTrigMode {
	out "SOUR:PULM:TRIG:MODE?";
	in "%{AUTO|EXT|EGAT}";
}
##################################################################################
# Set trigger mode for PM signal

outPMTrigMode {
	out "SOUR:PULM:TRIG:MODE %{AUTO|EXT|EGAT}";
	@init { inPMTrigMode; };
}
##################################################################################
# Read noise level in the system bandwidth

inNoisBwid {
	out "SOUR:NOIS:BWID?";
	in "%f";
}
###################################################################################
# Set noise level in the system bandwidth

outNoisBwid {
	out "SOUR:NOIS:BWID %f";
	@init { inNoisBwid; };
}
###################################################################################
# Read the noise power density distribution of the noise

inNoisDist {
	out "SOUR:NOIS:DIST?";
	in "%{GAUS|EQU}";
}
###################################################################################
# Set the noise power density distribution of the noise

outNoisDist {
	out "SOUR:NOIS:DIST %{GAUS|EQU}";
	@init { inNoisDist; };
}
####################################################################################
# Read the center frequency of the RF sweep range

inFreqCentr {
	out "SOUR:FREQ:CENT?";
	in "%f";
}
####################################################################################
# Set the center frequency of the RF sweep range

outFreqCentr {
	out "SOUR:FREQ:CENT %f";
	@init { inFreqCentr; };
}
####################################################################################
# Read the frequency manually written

inFreqMan {
	out "SOUR:FREQ:MAN?";
	in "%f";
}
####################################################################################
# Set the frequency manually

outFreqMan {
	out "SOUR:FREQ:MAN %f";
	@init { inFreqMan; };
}
####################################################################################
# Read the extent of the frequency sweep range

inFreqSpan {
	out "SOUR:FREQ:SPAN?";
	in "%f";
}
####################################################################################
# Set the extent of the frequency sweep range

outFreqSpan {
	out "SOUR:FREQ:SPAN %f";
	@init { inFreqSpan; };
}
####################################################################################
# Read the step width

inFStepWid {
	out "SOUR:FREQ:STEP:INCR?";
	in "%f";
}
####################################################################################
# Set the step width

outFStepWid {
	out "SOUR:FREQ:STEP:INCR %f";
	@init { inFStepWid; };
}
####################################################################################
# Read frequency range mode

inModeFreq {
	out "SOUR:FREQ:PHAS:CONT:MODE?";
	in "%{NARR|WIDE}";
}
####################################################################################
# Set frequency range mode

outModeFreq {
	out "SOUR:FREQ:PHAS:CONT:MODE ${NARR|WIDE}";
	@init { inModeFreq; };
}
####################################################################################
# Read dwell time

inFDwellTime {
	out "SOUR:SWE:POW:DWEL?";
	in "%f";
}
#####################################################################################
# Set dwell time

outFDwellTime {
	out "SOUR:SWE:POW:DWEL %f";
	@init { inFDwellTime; };
}
#####################################################################################
# Read cycle mode of the level sweep

inFCycleMode {
	out "SOUR:SWE:POW:MODE?";
	in "%{AUTO|MAN|STEP}";
}
#####################################################################################
# Set cycle mode of the level sweep

outFCycleMode {
	out "SOUR:SWE:POW:MODE %{AUTO|MAN|STEP}";
	@init { inFCycleMode; };
}
######################################################################################
# Read the number of points for the level sweep

inSweepPts {
	out "SOUR:SWE:POW:POIN?";
	in "%i";
}
######################################################################################
# Set the number of points for the level sweep

outSweepPts {
	out "SOUR:SWE:POW:POIN %i";
	@init { inSweepPts; };
}
######################################################################################
# Read the state of the power retrace

inFPwrRetr {
	out "SOUR:SWE:POW:RETR?";
	in "%i";
}
######################################################################################
# Set the state of the power retrace

outFPwrRetr {
	out "SOUR:SWE:POW:RETR %{OFF|ON}";
	@init { inFPwrRetr; };
}
#######################################################################################
# Read the current state of the level sweep mode

inFPwrRun {
	out "SOUR:SWE:POW:RUNN?";
	in "%i";
}
#######################################################################################
# Read the cycle mode for a sweep sequence

inFPwrShp {
	out "SOUR:SWE:POW:SHAP?";
	in "%{SAWT|TRI}";
}
########################################################################################
# Set the cycle mode for a sweep sequence

outFPwrShp {
	out "SOUR:SWE:POW:SHAP %{SAWT|TRI}";
	@init { inFPwrShp; };
}
########################################################################################
# Read a logarithmically determined sweep step size for the RF level sweep

inFStepLog {
	out "SOUR:SWE:POW:STEP:LOG?";
	in "%f";
}
########################################################################################
# Set a logarithmically determined sweep step size for the RF level sweep

outFStepLog {
	out "SOUR:SWE:POW:STEP:LOG %f";
	@init { inFStepLog; };
}
########################################################################################
# Trigger Pulse

Pulse {
	out "TRIG:PSW:IMM";
}
########################################################################################
# Read user defined step width

inFStepMode {
	out "SOUR:FREQ:STEP:MODE?";
	in "%{DEC|USER}";
}
########################################################################################
# Set user defined step width

outFStepMode {
	out "SOUR:FREQ:STEP:MODE %{DEC|USER}";
	@init { inFStepMode; };
}
########################################################################################
# Execute single sweep

ExeSweep {
	out "SOUR:SWE:POW:EXEC";
}
########################################################################################
# Queries the sweep spacing mode

SpacMode {
	out "SOUR:SWE:POW:SPAC:MODE?";
	in "%{LIN}";
}
########################################################################################
# Resets all active sweeps to the starting point

RstAllSweep {
	out "SOUR:SWE:RES:ALL";
}
########################################################################################
# Read the state of the bandwidth limitation of noise

inNBwidState {
	out "SOUR:NOIS:BWID:STAT?";
	in "%i";
}
########################################################################################
# Enables/Disables the bandwidth limitation of noise

outNBwidState {
	out "SOUR:NOIS:BWID:STAT %{OFF|ON}";
	@init { inNBwidState; };
}
########################################################################################
# Read the DC offset which is added to both clock synthesis output signals

inCsynOffset {
	out "CSYN:OFFS?";
	in "%f";
}
########################################################################################
# Set the DC offset which is added to both clock synthesis output signals

outCsynOffset {
	out "CSYN:OFFS %f";
	@init { inCsynOffset; };
}
########################################################################################
# Read the state of the clock synthesis DC offset

inOffsetState {
	out "CSYN:OFFS:STAT?";
	in "%i";
}
########################################################################################
# Set the state of the clock synthesis DC offset

outOffsetState {
	out "CSYN:OFFS:STAT %{OFF|ON}";
	@init { inOffsetState; };
}
########################################################################################
#################################################################################################
# Refresh the value of ao/bo records after the switch between local -to- remote of $(DEV):LocRmt

Refresh {
    out "FREQ?";
    in "%(\$1:ConvValues.DO1)f";                                                # pointer to record $(DEVN):outRfq
    out "SOUR:PULM:WIDTH?";
    in "%(\$1:ConvValues.DO2)f";                                                # pointer to record $(DEVN):outPMWidt
    out "SOUR:PULM:PER?";
    in "%(\$1:ConvValues.DO3)f";                                                # pointer to record $(DEVN):outPMPer
    out "SOUR:LFO%(\$1:inc.VAL)s:FREQ?";
    in "%(\$1:ConvValues.DO4)f";                                                # pointer to record $(DEVN):outLFFrq
    out "SOUR:LFO%(\$1:inc.VAL)s:SHAP?";
        in  "%(\$1:ConvValues.DO5){SINE|SQU|TRI|TRAP}";         # pointer to record $(DEVN):outLFShap
        out "SOUR:POW:LEV:IMM:AMPL?";
        in "%(\$1:ConvValues.DO6)f";                                            # pointer to record $(DEVN):outRFLvl
        out "OUTP?";
        in "%(\$1:ConvValues.DO7)i";                                            # pointer to record $(DEVN):outRFstat
}
##################################################################################################



###########
